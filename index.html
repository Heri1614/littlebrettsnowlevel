<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LittleBrett Snow Level</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; background: #000; font-family: sans-serif; }
    canvas { display: block; background: #000; }
    #controls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 10;
    }
    .btn {
      width: 60px;
      height: 60px;
      background-size: cover;
      border: none;
      background-color: transparent;
    }
    #invokeButton {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background-image: url('invoke_btn.png');
      background-size: cover;
      border: none;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="controls">
    <button class="btn" id="leftBtn" style="background-image: url('btn_left.png');"></button>
    <button class="btn" id="rightBtn" style="background-image: url('btn_right.png');"></button>
    <button class="btn" id="jumpBtn" style="background-image: url('btn_jump.png');"></button>
  </div>
  <button id="invokeButton"></button>
  
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = innerWidth;
    canvas.height = innerHeight;

    const images = {};
    const imageSources = {
      bg: 'bg_forest.png',
      brett_idle: 'brett_idle.png',
      brett_walk: 'brett_walk1.png',
      brett_jump: 'brett_jump.png',
      brett_fall: 'brett_fall.png',
      platform_tall: 'Platform_tall.png',
      platform_small: 'Platform_small.png',
      platform_ice: 'platform_ice.png',
      log: 'log.png',
      coin: 'coin.png',
      btc: 'btc.png',
      eth: 'eth.png',
      enemy: 'enemy1.png',
      bull_fire: 'bull_fire.png'
    };

    let score = 0;
    let canInvoke = 0;

    const loadImages = async () => {
      const promises = Object.entries(imageSources).map(([key, src]) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.src = src;
          img.onload = () => {
            images[key] = img;
            resolve();
          };
        });
      });
      await Promise.all(promises);
    };

    const player = {
      x: 100,
      y: canvas.height - 180,
      width: 60,
      height: 60,
      vx: 0,
      vy: 0,
      grounded: true,
      image: "brett_idle"
    };

    const gravity = 1;
    const platforms = [
      { x: 0, y: canvas.height - 120, img: "log" },
      { x: 200, y: canvas.height - 200, img: "Platform_small" },
      { x: 400, y: canvas.height - 300, img: "Platform_tall" },
      { x: 650, y: canvas.height - 250, img: "platform_ice" }
    ];

    const coins = [
      { x: 210, y: canvas.height - 230, img: "coin" },
      { x: 420, y: canvas.height - 330, img: "btc" },
      { x: 670, y: canvas.height - 280, img: "eth" }
    ];

    const enemies = [
      { x: 900, y: canvas.height - 180 }
    ];

    let keys = { left: false, right: false, jump: false };

    const draw = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(images.bg, 0, 0, canvas.width, canvas.height);

      // Draw platforms
      platforms.forEach(p => {
        ctx.drawImage(images[p.img], p.x, p.y);
      });

      // Draw coins
      coins.forEach(c => {
        ctx.drawImage(images[c.img], c.x, c.y, 40, 40);
      });

      // Draw enemies
      enemies.forEach(e => {
        ctx.drawImage(images.enemy, e.x, e.y, 60, 60);
      });

      // Draw player
      ctx.drawImage(images[player.image], player.x, player.y, player.width, player.height);

      // Score
      ctx.fillStyle = "#fff";
      ctx.font = "24px sans-serif";
      ctx.fillText(`Score: ${score}`, 20, 30);

      // Update invoke button visibility
      document.getElementById("invokeButton").style.display = canInvoke > 0 ? 'block' : 'none';
    };

    const update = () => {
      if (keys.left) player.vx = -5;
      else if (keys.right) player.vx = 5;
      else player.vx = 0;

      if (!player.grounded) {
        player.vy += gravity;
        player.image = player.vy > 0 ? "brett_fall" : "brett_jump";
      } else {
        player.image = player.vx !== 0 ? "brett_walk" : "brett_idle";
      }

      player.x += player.vx;
      player.y += player.vy;

      // Ground/platform collision
      player.grounded = false;
      platforms.forEach(p => {
        const img = images[p.img];
        if (
          player.x < p.x + img.width &&
          player.x + player.width > p.x &&
          player.y + player.height < p.y + img.height &&
          player.y + player.height + player.vy >= p.y
        ) {
          player.vy = 0;
          player.grounded = true;
          player.y = p.y - player.height;
        }
      });

      if (player.y + player.height >= canvas.height - 60) {
        player.vy = 0;
        player.y = canvas.height - 60 - player.height;
        player.grounded = true;
      }

      // Coin collection
      coins.forEach((c, i) => {
        if (
          player.x < c.x + 40 &&
          player.x + player.width > c.x &&
          player.y < c.y + 40 &&
          player.y + player.height > c.y
        ) {
          coins.splice(i, 1);
          score += 100;
          canInvoke = Math.floor(score / 200);
        }
      });
    };

    const loop = () => {
      update();
      draw();
      requestAnimationFrame(loop);
    };

    const init = async () => {
      await loadImages();
      loop();
    };

    init();

    // Controls
    document.getElementById("leftBtn").addEventListener("touchstart", () => keys.left = true);
    document.getElementById("leftBtn").addEventListener("touchend", () => keys.left = false);
    document.getElementById("rightBtn").addEventListener("touchstart", () => keys.right = true);
    document.getElementById("rightBtn").addEventListener("touchend", () => keys.right = false);
    document.getElementById("jumpBtn").addEventListener("touchstart", () => {
      if (player.grounded) {
        player.vy = -18;
        player.grounded = false;
      }
    });

    document.getElementById("invokeButton").addEventListener("click", () => {
      canInvoke--;
      enemies.forEach(e => {
        e.x -= 2000;
      });
    });
  </script>
</body>
</html>
